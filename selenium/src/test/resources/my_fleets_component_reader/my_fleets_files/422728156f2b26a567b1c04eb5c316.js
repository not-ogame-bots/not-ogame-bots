ogame.chat={socket:null,connected:false,connecting:false,timeout:null,retryInterval:5000,playerId:null,associationId:null,data:{association:{}},playernames:{},playerList:null,isLoadingPlayerList:false,playerListSelector:new Array,initConnection:function(){var b=ogame.chat;if(b.connecting||b.connected||b.isMobile){if(this.socket){b.socket.disconnect()}}b.connecting=true;try{b.socket=io.connect("/chat",nodeParams);b.socket.on("connect",function(){clearTimeout(this.timeout);b.socket.emit("authorize",session,function(c){b.connecting=false;if(c){b.connected=true}else{b.socket.disconnect()}})});b.socket.on("chat",function(c){b.messageReceived(c)});b.socket.on("disconnect",function(){b.connected=false;b.connecting=false})}catch(a){b.connecting=false}},initialize:function(){var a=ogame.chat;loadScript(nodeUrl,a.initConnection);$(".new_msg_count[data-playerid]").each(function(){a.saveMessageCounter($(this).data("new-messages"),$(this).data("playerid"))});this.updateTotalNewChatCounter();$(".js_playerlist").on("click",".playerlist_item",function(){var b=$(this).hasClass("nothingThere");if(!b){var c=$(this).data("msgid");if(c){a.loadChatLogWithPlayer(this,c)}else{a.loadChatLogWithPlayer(this)}}});$(".js_playerlist").on("click",".openAssociationChat",function(){var b=$(this).data("msgid");if(b){a.loadChatLogWithAssociation(this,b)}else{a.loadChatLogWithAssociation(this)}});$("#chatMsgList").on("click",".msg",function(){var d=$(this).data("playerid");var b=$(this).data("associationid");if(d!==undefined&&d>0){a.saveMessageCounter(0,d);ogame.messagemarker.setPartnerId(d);ogame.messagemarker.updateNewMarker();ogame.chat.updateTotalNewChatCounter();var c=$(".playerlist .playerlist_item[data-playerId="+d+"]").data("msgid");if(c){a.loadChatLogWithPlayer(this,c)}else{a.loadChatLogWithPlayer(this)}}else{var c=$(".playerlist .playerlist_item[data-associationId="+b+"]").data("msgid");a.saveMessageCounterAssociation(0,b);if(c){a.loadChatLogWithAssociation(this,c)}else{a.loadChatLogWithAssociation(this)}}});$(".chat").on("click",".sys_msg",function(e){var c=$(this).data("foreign-player-id");var d=$(this).data("foreign-association-id");var b={playerId:c,associationId:d,ajax:1};$.ajax({url:chatUrlLoadMoreMessages,type:"POST",dataType:"html",data:b,success:function(f){$(".chat").each(function(g,h){if(c!==undefined&&c==$(h).data("foreign-player-id")){$(h).html(f)}else{if(d!==undefined&&d==$(h).data("foreign-association-id")){$(h).html(f)}}})},error:function(f,h,g){}})});$("body").on("click",".js_openChat",function(){a.loadChatLogWithPlayer(this)});if(typeof $.cookie("maximizeId")=="string"||typeof $.cookie("maximizeId")=="number"){$('#chatMsgList .msg[data-playerid="'+$.cookie("maximizeId")+'"]').trigger("click");$.cookie("maximizeId",null)}},getTotalNewChatCounter:function(){return ogame.messagecounter.sumNewChatMessages},updateTotalNewChatCounter:function(){var a=0;if($(".msg .new_msg_count").length>0){$(".msg .new_msg_count").each(function(){a+=Number($(this).data("new-messages"))})}else{if($("#chatBarPlayerList .new_msg_count").length>0){$("#chatBarPlayerList .new_msg_count").each(function(){a+=Number($(this).data("new-messages"))})}}ogame.messagecounter.initialize(ogame.messagecounter.type_chat,ogame.chat.playerId);if(ogame.messagecounter.sumNewChatMessages!==a){ogame.messagecounter.initChatCounter(a);ogame.messagecounter.sumNewChatMessages=a;ogame.messagecounter.update()}return a},retryConnection:function(){var a=ogame.chat;setTimeout(function(){a.initConnection()},5000)},sendMessage:function(c,e,i,j){var h=ogame.chat;if($.trim(i).length==0){d("TEXT_EMPTY");return}var a;if(c>0){a={playerId:c,text:i,mode:1,ajax:1,token:window.ajaxChatToken}}else{a={associationId:e,text:i,mode:3,ajax:1,token:window.ajaxChatToken}}if(typeof j!=="undefined"&&typeof j.id!=="undefined"){a.msg2reply=j.id}function b(){$.ajax({url:chatUrl,type:"POST",dataType:"json",data:a,success:function(k){g(k);window.ajaxChatToken=k.newToken},error:function(k,m,l){}})}function f(k){if(typeof k.refAuthor!=="undefined"&&typeof k.refContent!=="undefined"){$refData={author:k.refAuthor,text:k.refContent}}else{$refData=0}if(k.targetId!==undefined){h.addChatItem(k.targetId,0,k.text,k.id,false,$refData,k.date)}else{h.addChatItem(c,k.targetAssociationId,k.text,k.id,false,$refData,k.date)}}function d(k){if(chatLoca[k]!==undefined){errorBoxNotify(LocalizationStrings.error,chatLoca[k],LocalizationStrings.ok)}else{errorBoxNotify(LocalizationStrings.error,k,LocalizationStrings.ok)}}function g(k){switch(k.status){case"NOT_AUTHORIZED":b();break;case"OK":f(k);ogame.chat.cleanupUrl();break;default:d(k.status)}}b()},messageReceived:function(c){var d=ogame.chat;if(typeof c.refAuthor!=="undefined"&&typeof c.refText!=="undefined"){$refData={author:c.refAuhtor,text:c.refText}}else{$refData=0}if(c.senderName!==undefined&&c.senderId!==undefined){d.playernames[c.senderId]=c.senderName}if($(".chat_bar_list").length){if(c.associationId!==undefined&&c.associationId>0){if(d.data.association[c.associationId]===undefined){d.loadChatLogWithAssociation(c.associationId,null,function(){d.addChatItem(c.senderId,c.associationId,c.text,c.id,true,$refData,c.date)},false)}else{d.addChatItem(c.senderId,c.associationId,c.text,c.id,true,$refData,c.date)}}else{if(d.data[c.senderId]===undefined){d.loadChatLogWithPlayer(c.senderId,null,function(){d.addChatItem(c.senderId,0,c.text,c.id,true,$refData,c.date)},false)}else{d.addChatItem(c.senderId,0,c.text,c.id,true,$refData,c.date)}}}if(c.associationId!==undefined&&c.associationId>0){if($('.chat_bar_list_item.open[data-associationid="'+c.associationId+'"]').length<=0){var b=$('.new_msg_count[data-associationid="'+c.associationId+'"]').data("new-messages");if(isNaN(b)){b=0}b++;d.saveMessageCounterAssociation(b,c.associationId);d.updateTotalNewChatCounter()}else{var a={associationId:c.associationId,mode:4,ajax:1,updateUnread:1};$.ajax({url:chatUrl,type:"POST",data:a,success:function(e){},error:function(e,g,f){}})}}else{if(c.senderId!==undefined&&c.senderId>0){ogame.messagemarker.setPartnerId(c.senderId);if(!d.isOpen(c.senderId)){ogame.messagecounter.initialize(ogame.messagecounter.type_chat,c.senderId);var b=parseInt(ogame.messagecounter.newChats[c.senderId]);if(isNaN(b)){b=0}b++;d.saveMessageCounter(b,c.senderId);ogame.messagemarker.updateNewMarker()}else{d.saveMessageCounter(0,$(this).data("playerid"));ogame.messagemarker.updateNewMarker()}}}},cleanupUrl:function(){},saveMessageCounter:function(b,a){if(isNaN(a)||a===0){return false}$('.new_msg_count[data-playerid="'+a+'"]').data("new-messages",b);ogame.messagecounter.newChats[a]=b},saveMessageCounterAssociation:function(b,a){if(isNaN(a)||a===0){return false}$('.new_msg_count[data-associationid="'+a+'"]').data("new-messages",b);$('.new_msg_count[data-associationid="'+a+'"]').text(b);ogame.messagemarker.updateNewMarker()},isOpen:function(a){var c=false;var b=$(".chatContent").data("chatplayerid");if(b!="undefined"&&b==a){c=true}else{$(".chat_box").each(function(){if($(this).attr("data-playerid")==a){if($(this).css("display")=="block"){c=true}}})}return c},loadChatLogWithPlayer:function(c,e,g,b){var f=ogame.chat;var d;if(typeof b=="undefined"){b=true}if(typeof c=="number"){d=c}else{d=$(c).attr("data-playerId")}var a={playerId:d,mode:2,ajax:1,updateUnread:(b?1:0)};if(typeof e=="number"){a.msg2reply=e}$.ajax({url:chatUrl,type:"POST",data:a,success:function(i){i=JSON.parse(i);f.data[i.playerId]={playerstatus:i.playerstatus,playerName:i.playerName,playerId:i.playerId,chatItems:i.chatItems,chatItemsByDateAsc:i.chatItemsByDateAsc};if(typeof g=="function"){g()}else{if($(c).parents("#chatBarPlayerList").length||$("body")[0].id!="chat"){f.showChat(i)}else{f.showChatHistory(i)}}var h=$(".chat_bar_list").find("[data-playerid='"+i.playerId+"']");f.updateCustomScrollbar(h.find(".chat_box_ctn"))},error:function(h,j,i){}})},loadChatLogWithAssociation:function(d,e,g,b){var f=ogame.chat;var c;if(typeof b=="undefined"){b=true}if(typeof d=="number"){c=d}else{c=$(d).attr("data-associationid")}var a={associationId:c,mode:4,ajax:1,updateUnread:(b?1:0)};if(typeof e=="number"){a.msg2reply=e}$.ajax({url:chatUrl,type:"POST",data:a,success:function(i){i=JSON.parse(i);f.data.association[i.associationId]={playerstatus:i.playerstatus,associationName:i.associationName,associationId:i.associationId,chatItems:i.chatItems,chatItemsByDateAsc:i.chatItemsByDateAsc};if(typeof g=="function"){g()}else{if($(d).parents("#chatBarPlayerList").length||$("body")[0].id!="chat"){f.showChat(i)}else{f.showChatHistory(i)}}var h=$(".chat_bar_list").find("[data-associationid='"+i.associationId+"']");f.updateCustomScrollbar(h.find(".chat_box_ctn"))},error:function(h,j,i){}})},initChat:function(b,a){ogame.chat.playerId=b;ogame.chat.isMobile=a;ogame.chat.initPlayerlist();ogame.chat.initialize();ogame.chat.toggleVisibility();ogame.chat.setVisibilityState();ogame.chat.initMaximize();ogame.chat.getInMaxChat()},getLastChatItemData:function(){var c=ogame.chat;var e=null;$(".chat_box_ctn .mCustomScrollBox .mCSB_container").each(function(){var f=$(this).children("ul.chat").children("li:last");if(e===null||f.attr("data-chat-id")>e.attr("data-chat-id")){e=f}});if(e===null){$("ul.largeChat").each(function(){var f=$(this).children("li:last");if(e===null||f.attr("data-chat-id")>e.attr("data-chat-id")){e=f}})}if(e===null){return null}var d=e.children(".msg_head").find(".msg_date").html();var b=e.find(".msg_content").html();var a={date:d,text:b};return a},addChatItem:function(a,h,e,c,j,f,m){var k=ogame.chat;var n;if(h>0){n=$(".chat_bar_list").find("[data-associationid='"+h+"']")}else{n=$(".chat_bar_list").find("[data-playerid='"+a+"']")}var g={};g.date=m;g.newClass="new";if(j){if(k.data[a]!==undefined){g.playerName=k.data[a].playerName}else{g.playerName=k.playernames[a]}g.altClass=""}else{g.playerName=playerName;g.altClass="odd"}g.chatID=c;g.chatContent=e;if(typeof f=="object"){g.refData=f}if(!n.length){var b=k.createChatBarContainer(a);k.updateChatBar(b);n=$(".chat_bar_list").find("[data-playerid='"+a+"']")}var i=k.createChatItem(g);var l=k.getLastChatItemData();if(l!==null&&(g.date!=l.date||g.chatContent!=l.text)){n.find(".chat").append(i);k.updateCustomScrollbar(n.find(".chat_box_ctn"));var d=$(".js_chatHistory");if(d.length&&(d.data("chatplayerid")==a||d.data("associationid")==h)){d.find(".chat.clearfix").append(i.clone());k.updateCustomScrollbar($(".largeChatContainer"))}}},addToMoreBox:function(d){var e=ogame.chat;var f=d.length;if(f&&$(".more_chat_bar_items").length<1){$(".chat_bar_list").append(e.createMoreBox("more_chat_bar_items"))}var b=$(".more_chat_bar_items .more_items");var a=$(".more_chat_bar_items .chat_box");for(var c=0;c<=f;c++){b.append(d.pop())}e.updateCustomScrollbar(a)},createChatBarContainer:function(a){var d=ogame.chat;if(!a){return}var c=d.data[a];d.data.playerId=a;var b=$('<li class="chat_bar_list_item open" data-playerid="'+a+'"></li>');b.append('<span class="playerstatus '+c.playerstatus+'"></span>');b.append('<span class="cb_playername">'+c.playerName+"</span>");b.append('<span class="icon icon_close fright"></span>');b.prepend(d.createChatBox(a));return b},createChatBarContainerForAssociations:function(a){var d=ogame.chat;if(!a){return}var c=d.data.association[a];d.data.associationId=a;var b=$('<li class="chat_bar_list_item open" data-associationId="'+a+'"></li>');b.append('<span class="playerstatus '+c.playerstatus+'"></span>');b.append('<span class="cb_playername">'+c.associationName+"</span>");b.append('<span class="icon icon_close fright"></span>');b.prepend(d.createChatBoxForAssociations(a));return b},closeChatBox:function(c,b){var a=$(".chat_bar_list_item");$.each(a,function(d,e){if(c!==undefined&&$(e).data("playerid")==c){$(e).addClass("outOfChatbar");$(e).removeClass("open")}else{if(b!==undefined&&$(e).data("associationid")==b){$(e).addClass("outOfChatbar");$(e).removeClass("open")}}})},getVisibleChats:function(){if(typeof visibleChats=="undefined"){visibleChats={chatbar:false,players:[],associations:[]}}return visibleChats},getVisibleChatPlayerIds:function(){var d=ogame.chat;var c=d.getVisibleChats();var e={};var a=0;for(var b=0;b<c.players.length;b++){if($.inArray(c.players[b]["partnerId"],e)==-1){e[a]=c.players[b]["partnerId"];a++}}return e},getVisibleChatAssociationIds:function(){var e=ogame.chat;var d=e.getVisibleChats();var c={};var a=0;for(var b=0;b<d.associations.length;b++){if($.inArray(d.associations[b]["partnerId"],c)==-1){c[a]=d.associations[b];a++}}return c},setVisibilityState:function(){var g=ogame.chat;var b=g.getVisibleChatPlayerIds();var h=g.getVisibleChatAssociationIds();var f=$("#chatBar .chat_bar_list .chat_bar_list_item");for(var d=0;d<f.length;d++){var j=f.get(d);var a=$(j).data("playerid");var c=$(j).data("associationid");if(a!==undefined&&!g.isInJson(a,b)){g.closeChatBox(a,0)}else{if(c!==undefined&&!g.isInJson(c,h)){g.closeChatBox(0,c)}else{j.style.display="inline";if($(j).hasClass("open")){var e=$(j).find("div.chat_box")[0];e.style.display="inline";g.updateCustomScrollbar($(j).find(".chat_box_ctn"),1)}}}}},isInJson:function(c,b){var a=null;if($.isEmptyObject(b)){a=false}if(a!==false){$.each(b,function(e,d){if(d==c){a=true}});if(a!==true){false}}return a},toggleVisibility:function(){$(".chat_bar_list_item .icon_close").on("click",function(c){var a=$(this).parent().data("playerid");var b=$(this).closest(".chat_box");if(!b.length){b=$(this).parent()[0];b.style.display="none"}if(a>0){$.ajax({type:"POST",url:"/game/index.php?page=ajaxChatToggleVisibility",data:{from:playerId,to:a,showState:0},success:function(d){},error:function(d,f,e){}})}});$(".cb_playerlist_box .playerlist_item").on("click",function(){var a=$(this).data("playerid");if(a){$.ajax({type:"POST",url:"/game/index.php?page=ajaxChatToggleVisibility",data:{from:playerId,to:a,showState:1},success:function(b){},error:function(b,d,c){}})}})},initMaximize:function(){$(".chat_bar_list").on("click.chatBar",".chat_box .chat_box_title .icon_maximize",function(){var b=$(this).parent();var a=$(b).parent().data("playerid");$.cookie("maximizeId",a);$(".chat_bar_list_item.open .chat_box_title .icon_close").trigger("click");window.location=bigChatLink+"&playerId="+a})},getInMaxChat:function(){var a=location.href;if(typeof bigChatLink=="undefined"){bigChatLink=""}if(bigChatLink==a){if($.cookie("maximizeId")!==null){$("#chatMsgList .msg[data-playerId="+$.cookie("maximizeId")+"]").trigger("click")}}$.cookie("maximizeId",null)},createChatBox:function(a){var g=ogame.chat;if(!a){return}var e=g.data[a];var c=$('<div class="chat_box_title"></div>');c.append('<span class="icon icon_close fright"></span>');c.append('<span class="icon icon_maximize fright"></span>');var h=$('<div class="chat_box_ctn"><ul class="chat clearfix"></ul></div>');var b={};for(var d=0;d<e.chatItemsByDateAsc.length;d++){b=e.chatItems[e.chatItemsByDateAsc[d]];h.find(".chat").append(g.createChatItem(b))}var f=$('<div class="chat_box" data-playerid="'+a+'"></div>');f.append(c);f.append(h);f.append('<textarea name="text" class="chat_box_textarea"></textarea>');return f},createChatBoxForAssociations:function(c){var g=ogame.chat;if(!c){return}var e=g.data.association[c];var b=$('<div class="chat_box_title"></div>');b.append('<span class="icon icon_close fright"></span>');b.append('<span class="icon icon_maximize fright"></span>');var h=$('<div class="chat_box_ctn"><ul class="chat clearfix"></ul></div>');var a={};for(var d=0;d<e.chatItemsByDateAsc.length;d++){a=e.chatItems[e.chatItemsByDateAsc[d]];h.find(".chat").append(g.createChatItem(a))}var f=$('<div class="chat_box" data-associationId="'+c+'"></div>');f.append(b);f.append(h);f.append('<textarea name="text" class="chat_box_textarea"></textarea>');return f},createChatItem:function(d){if(!d){console.warn("no chatItem given");return}var b=$('<div class="msg_head"></div>');b.append('<span class="msg_date fright">'+getFormatedDate(d.date,"[d].[m].[Y] <span>[H]:[i]:[s]</span>")+"</span>");b.append('<span class="msg_title blue_txt '+d.newClass+'">'+d.playerName+"</span>");var a=$('<li class="chat_msg '+d.altClass+'" data-chat-id="'+d.chatID+'"></li>');a.append(b);if(typeof d.refData!=="undefined"){var f=$('<div class="referenceMsg"></div>');var c='<div class="refAuthor">'+d.refData.author+"</div>";var e='<div class="refText new">'+d.refData.text+"</div>";f.append(c);f.append(e);a.append(f)}a.append('<span class="msg_content">'+d.chatContent+"</span>");a.append('<div class="speechbubble_arrow"></div>');return a},createMoreBox:function(a){var b=$('<li class="chat_bar_list_item '+a+'">'+chatLoca.MORE_USERS+'<span class="icon icon_close fright"></span></li>');b.prepend($('<div class="chat_box"><ul class="more_items clearfix"></ul></div>'));return b},filterPlayerlist:function(){var c=[];var e;var d=$("#playerlistFilters").find('input[type="checkbox"]');d.each(function(){c.push($(this).attr("id"))});$(".playerlist_item").show();e=false;d.each(function(){if($(this).prop("checked")){e=true}});if(!e){return}var b;var a;$(".playerlist_item").filter(function(){b=false;a=$(this);$.each(c,function(f,g){if(a.data(g)==="off"&&$("#"+g).prop("checked")){b=true}});(b===true)?a.hide():a.show()})},initChatBar:function(a){var b=ogame.chat;ogame.chat.playerId=a;$("html").off(".chatBar");$(window).resize(function(){b.updateChatBar()});$(".chat_bar_list").on("click.chatBar","#chatBarPlayerList",function(c){if($(c.target).attr("id")!=="chatBarPlayerList"&&!$(c.target).hasClass("onlineCount")){return}$(".cb_playerlist_box").toggle();b.updateCustomScrollbar($(".scrollContainer"),true);$.ajax({url:chatUrl,type:"POST",dataType:"json",data:{action:"toggleChatBar"},success:function(d){},error:function(d,f,e){}})}).on("click.chatBar",".chat_bar_list_item",function(c){c.stopPropagation();if(!isNaN($(this).data("playerid"))){ogame.messagemarker.toggle(ogame.messagemarker.action_remove,ogame.messagemarker.type_chattab,$(this).data("playerid"));ogame.messagemarker.toggle(ogame.messagemarker.action_remove,ogame.messagemarker.type_chatbar,$(this).data("playerid"));b.saveMessageCounter(0,$(this).data("playerid"));ogame.messagemarker.setPartnerId($(this).data("playerid"));ogame.messagemarker.updateNewMarker();ogame.chat.updateTotalNewChatCounter()}else{if(!isNaN($(this).data("associationid")>0)){b.saveMessageCounterAssociation(0,$(this).data("associationid"))}}$.ajax({url:chatUrl,type:"POST",dataType:"json",data:{playerId:$(this).data("playerid"),action:"chatBarListRead"},success:function(d){},error:function(d,f,e){}});if($(this).closest(".more_items").length){b.swapChatBarItem($(this))}else{b.toggleChatBox($(c.target),$(this))}b.updateVisibleState()}).on("click.chatBar",".chat_bar_list_item > .icon_close",function(d){d.stopPropagation();var c=$(this).closest(".chat_bar_list_item");ogame.chat.closeChatBox(c.attr("data-playerid"),c.attr("data-associationid"));c.remove("open");b.updateChatBar()}).on("keyup.chatBar",".chat_box_textarea",function(d){if((d.ctrlKey||d.keyCode==10)&&d.keyCode==13){d.preventDefault();var c=$(this).val();$(this).val(c+"\n")}else{if($.trim($(this).val().length>0)){d.preventDefault();b.submitChatBarMsg($(d.currentTarget),d.which,d.shiftKey,d.delegateTarget.scrollHeight)}}}).on("click.chatBar",".chat_box_textarea",function(c){ogame.messagemarker.toggle(ogame.messagemarker.action_remove,ogame.messagemarker.type_chattab,$(this).parent().parent().parent().data("playerid"));ogame.messagemarker.toggle(ogame.messagemarker.action_remove,ogame.messagemarker.type_chatbar,$(this).parent().parent().parent().data("playerid"));if($(this).data("playerid")>0){b.saveMessageCounter(0,$(this).data("playerid"))}else{if($(this).data("associationid")>0){b.saveMessageCounterAssociation(0,$(this).data("associationid"))}}})},initPlayerlist:function(){var b=ogame.chat;var a=ogame.tools;$(".js_accordion").accordion({collapsible:true,heightStyle:"content"});$(".playerlist_item:odd").addClass("odd");a.addHover(".playerlist_item, .msg, .playerlist_top_box .playerlist");$(".js_playerlist").on("click.playerList",".pl_filter_set",function(){b.filterPlayerlist()});b.filterPlayerlist()},showChat:function(c){var b=false;var d=ogame.chat;$(".chat_bar_list_item").each(function(){var e=$(this);if((c.playerId!==undefined&&e.data("playerid")===c.playerId)||(c.associationId!==undefined&&e.data("associationid")===c.associationId)){b=true;if(e.hasClass("outOfChatbar")){e.removeClass("outOfChatbar")}if(!e.hasClass("open")){e.click();e[0].style.display="inline"}else{e.fadeTo("400",0.3).fadeTo("400",1)}e.find("textarea").focus()}});if(!b){var a;if(c.playerId!==undefined){a=d.createChatBarContainer(c.playerId)}else{a=d.createChatBarContainerForAssociations(c.associationId)}d.updateChatBar(a)}},showChatHistory:function(a){var b=$(".js_chatHistory");var c=a.data;if(b.length){b.remove()}$("#chatList").remove();$(c).insertAfter("#planet");$("li.playerlist_item").removeClass("active");$("li.playerlist_item[data-playerid='"+a.playerId+"']").addClass("active");initBBCodeEditor(locaKeys,itemNames,false,".new_msg_textarea",2000,true)},submitChatBarMsg:function(c,g,b,f){var d=ogame.chat;var e=parseInt($(".chat_box_textarea").css("max-height"));var a=parseInt($(".chat_box_textarea").css("padding-top"))+parseInt($(".chat_box_textarea").css("padding-bottom"));if(g===13&&b){if(f<=(e+a)){c.css("height",f-a)}return}if(g===13){if(c.parent(".chat_box").data("playerid")!==undefined){d.sendMessage(c.parent(".chat_box").data("playerid"),0,c.val())}else{if(c.parent(".chat_box").data("associationid")!==undefined){d.sendMessage(0,c.parent(".chat_box").data("associationid"),c.val())}}c.val("")}},swapChatBarItem:function(b){var c=ogame.chat;var a=$(".more_chat_bar_items").prev();a.removeClass("open").find(".icon_close").hide().end().find(".chat_box").hide();a.remove();b.addClass("open").find(".icon_close").show().end().find(".chat_box").show().end().insertBefore(".more_chat_bar_items");c.addToMoreBox([a]);c.updateChatBar();c.updateCustomScrollbar(b.find(".chat_box_ctn"))},toggleChatBox:function(b,c){var e=ogame.chat;if(b.parents(".chat_box").length&&!b.hasClass("icon_close")){return}var d=c.children(".chat_box");if(d.is(":visible")){d.hide();c.removeClass("open")}else{if(!c.hasClass("more_chat_bar_items")){c.addClass("open");e.updateChatBar()}d.show();var a=d.find(".chat_box_ctn");if(c.hasClass("more_chat_bar_items")){a=d}e.updateCustomScrollbar(a);d.find("textarea").focus()}ogame.messagecounter.resetCounterByType(ogame.messagecounter.type_chat)},handleTooMuchWindows:function(f,i,a,b,e,c){var d=ogame.chat;var g=true;var h=[];$($(".chat_bar_list > .chat_bar_list_item").get().reverse()).each(function(){var j=$(this);if(g){if(j.hasClass("more_chat_bar_items")||j.attr("id")==="chatBarPlayerList"){return}if(j.hasClass("open")){f--}else{i--}j.removeClass("open").find(".icon_close").hide().end().find(".chat_box").hide();h.push(j);j.remove();widthTotal=b*i+a*f+e;g=(widthTotal>=c)?true:false}});d.addToMoreBox(h)},getItemFromMorelist2Chatbar:function(){var b=$(".more_items .chat_bar_list_item").first().remove();var a=ogame.chat;b.addClass("open").find(".icon_close").show().end().find(".chat_box").show().end().insertBefore(".more_chat_bar_items");if($(".more_items .chat_bar_list_item").length<=0){$(".more_chat_bar_items").remove()}a.updateCustomScrollbar($(".more_chat_bar_items>.chat_box"));a.updateCustomScrollbar(b.find(".chat_box_ctn"))},updateChatBar:function(i){var e=ogame.chat;var h=$(".chat_bar_list > .chat_bar_list_item.open").length;var b=$(".more_chat_bar_items").length;var j=$(".chat_bar_list").children().length-h-b;var c=190;var a=270;var f=190;var d=$("body").innerWidth();if(i){h++}var g=c*j+a*h+f*b;if(g>=d){e.handleTooMuchWindows(h,j,a,c,f,d)}else{if((g+a)<=d&&$(".more_chat_bar_items").length>0){e.getItemFromMorelist2Chatbar()}}if(i){i.insertAfter("#chatBarPlayerList");e.updateCustomScrollbar(i.find(".chat_box_ctn"))}},updateCustomScrollbar:function(b,a){if(!b||b.length==0){return}if(b.hasClass("mCustomScrollbar")){b.mCustomScrollbar("update")}else{b.mCustomScrollbar({theme:"ogame"})}if(a!==true){b.mCustomScrollbar("scrollTo","bottom",{scrollInertia:0})}b.each(function(){if($(this).height()+"px"==$(this).css("max-height")){$(this).addClass("scrollbarPresent")}})},updateVisibleState:function(){var a={chatbar:false,players:[],associations:[]};$(".chat_bar_list>.chat_bar_list_item").each(function(){var b=$(this);if(b.attr("id")==="chatBarPlayerList"&&b.children(".cb_playerlist_box").is(":visible")){a.chatbar=true}else{if(b.data("playerid")&&b.children(".chat_box").is(":visible")){a.players.push(b.data("playerid"))}else{if(b.data("associationid")&&b.children(".chat_box").is(":visible")){a.associations.push(b.data("associationid"))}}}});$.cookie("visibleChats",JSON.stringify(a),{expires:7})},showPlayerList:function(a){var b=ogame.chat;if(window.deactivateChatBecauseOfLogout){return}if($.inArray(a,b.playerListSelector)===-1){b.playerListSelector.push(a)}if(b.isLoadingPlayerList===false&&b.playerList===null){b.isLoadingPlayerList=true;$.ajax({url:chatUrl,type:"POST",dataType:"json",data:{action:"showPlayerList"},success:function(c){b.playerList=c.content;b.isLoadingPlayerList=false;b._showPlayerList()},error:function(c,e,d){b.isLoadingPlayerList=false}})}else{b._showPlayerList()}},_showPlayerList:function(){var a=ogame.chat;$.each(a.playerListSelector,function(b,c){$(c).html(a.playerList)})}};